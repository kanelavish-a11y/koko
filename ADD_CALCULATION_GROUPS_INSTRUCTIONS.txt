================================================================================
CALCULATION GROUPS - ADD TO YOUR MODEL
================================================================================

INSTRUCTIONS:
1. Open your SMM.txt file in a text editor (VS Code recommended)
2. Find the line that says "table Targets" (around line 2713)
3. INSERT the code below BEFORE "table Targets"
4. Save the file
5. Open in Power BI Desktop

================================================================================
CODE TO INSERT (copy everything between the dashed lines):
================================================================================

	/// Time comparison calculations for quarterly snapshot data. Apply to any measure to see current, prior quarter, prior year, or changes.
	table 'Time Comparison'
		lineageTag: 11111111-2222-3333-4444-555555555501

		calculationGroup
			precedence: 10

			/// Shows current period values as selected
			calculationItem 'Current Period' = SELECTEDMEASURE()
				ordinal: 0

			/// Shows prior quarter values for comparison
			calculationItem 'Prior Quarter' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorQuarterDate = EDATE(CurrentDate, -3)
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] = PriorQuarterDate
						)
				ordinal: 1

			/// Shows same quarter from prior year
			calculationItem 'Prior Year' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorYearDate = EDATE(CurrentDate, -12)
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] = PriorYearDate
						)
				ordinal: 2

			/// Quarter-over-quarter change (current minus prior)
			calculationItem 'QoQ Change' =
					VAR CurrentValue = SELECTEDMEASURE()
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorQuarterDate = EDATE(CurrentDate, -3)
					VAR PriorValue = CALCULATE(
						SELECTEDMEASURE(),
						'SnapshotDate_End'[Snapshot Date] = PriorQuarterDate
					)
					RETURN
						CurrentValue - PriorValue
				ordinal: 3

			/// Year-over-year change (current minus prior year)
			calculationItem 'YoY Change' =
					VAR CurrentValue = SELECTEDMEASURE()
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorYearDate = EDATE(CurrentDate, -12)
					VAR PriorValue = CALCULATE(
						SELECTEDMEASURE(),
						'SnapshotDate_End'[Snapshot Date] = PriorYearDate
					)
					RETURN
						CurrentValue - PriorValue
				ordinal: 4

			/// Quarter-over-quarter percentage change
			calculationItem 'QoQ Change %' =
					VAR CurrentValue = SELECTEDMEASURE()
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorQuarterDate = EDATE(CurrentDate, -3)
					VAR PriorValue = CALCULATE(
						SELECTEDMEASURE(),
						'SnapshotDate_End'[Snapshot Date] = PriorQuarterDate
					)
					RETURN
						DIVIDE(CurrentValue - PriorValue, PriorValue)
				formatString: +0.0%;-0.0%;0.0%
				ordinal: 5

			/// Year-over-year percentage change
			calculationItem 'YoY Change %' =
					VAR CurrentValue = SELECTEDMEASURE()
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorYearDate = EDATE(CurrentDate, -12)
					VAR PriorValue = CALCULATE(
						SELECTEDMEASURE(),
						'SnapshotDate_End'[Snapshot Date] = PriorYearDate
					)
					RETURN
						DIVIDE(CurrentValue - PriorValue, PriorValue)
				formatString: +0.0%;-0.0%;0.0%
				ordinal: 6

		column 'Time Comparison'
			dataType: string
			lineageTag: 11111111-2222-3333-4444-555555555502
			summarizeBy: none
			sourceColumn: Name
			sortByColumn: Ordinal

		column Ordinal
			dataType: int64
			isHidden
			lineageTag: 11111111-2222-3333-4444-555555555503
			summarizeBy: sum
			sourceColumn: Ordinal

		partition 'Time Comparison' = calculationGroup

	/// Period aggregation options using Federal Fiscal Year (Oct 1 - Sep 30). Apply to any measure for different time views.
	table 'Period Selector'
		lineageTag: 22222222-3333-4444-5555-666666666601

		calculationGroup
			precedence: 20

			/// Current period - no modification
			calculationItem 'Current' = SELECTEDMEASURE()
				ordinal: 0

			/// Fiscal Year to Date - from Oct 1 to selected date
			calculationItem 'FYTD' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR FYStart = IF(MONTH(CurrentDate) >= 10, 
						DATE(YEAR(CurrentDate), 10, 1),
						DATE(YEAR(CurrentDate) - 1, 10, 1))
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] >= FYStart,
							'SnapshotDate_End'[Snapshot Date] <= CurrentDate,
							ALL('SnapshotDate_End'),
							ALL('SnapshotDate_Start')
						)
				ordinal: 1

			/// Fiscal Quarter to Date - from start of fiscal quarter to selected date
			calculationItem 'FQTD' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR CurrentMonth = MONTH(CurrentDate)
					VAR FQStart = 
						SWITCH(TRUE(),
							CurrentMonth IN {10, 11, 12}, DATE(YEAR(CurrentDate), 10, 1),
							CurrentMonth IN {1, 2, 3}, DATE(YEAR(CurrentDate), 1, 1),
							CurrentMonth IN {4, 5, 6}, DATE(YEAR(CurrentDate), 4, 1),
							DATE(YEAR(CurrentDate), 7, 1)
						)
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] >= FQStart,
							'SnapshotDate_End'[Snapshot Date] <= CurrentDate,
							ALL('SnapshotDate_End'),
							ALL('SnapshotDate_Start')
						)
				ordinal: 2

			/// Rolling 4 quarters (12 months) average - smooths seasonal variations
			calculationItem 'Rolling 4Q Avg' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR StartDate = EDATE(CurrentDate, -12)
					VAR QuarterCount = 
						CALCULATE(
							DISTINCTCOUNT('SnapshotDate_End'[Snapshot Date]),
							'SnapshotDate_End'[Snapshot Date] > StartDate,
							'SnapshotDate_End'[Snapshot Date] <= CurrentDate,
							ALL('SnapshotDate_End')
						)
					RETURN
						DIVIDE(
							CALCULATE(
								SELECTEDMEASURE(),
								'SnapshotDate_End'[Snapshot Date] > StartDate,
								'SnapshotDate_End'[Snapshot Date] <= CurrentDate,
								ALL('SnapshotDate_End'),
								ALL('SnapshotDate_Start')
							),
							QuarterCount
						)
				ordinal: 3

			/// Same quarter in prior fiscal year
			calculationItem 'Same Qtr PFY' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR PriorYearDate = EDATE(CurrentDate, -12)
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] = PriorYearDate
						)
				ordinal: 4

			/// Full prior fiscal year total
			calculationItem 'Prior FY Total' =
					VAR CurrentDate = MAX('SnapshotDate_End'[Snapshot Date])
					VAR CurrentFY = IF(MONTH(CurrentDate) >= 10, YEAR(CurrentDate) + 1, YEAR(CurrentDate))
					VAR PriorFYStart = DATE(CurrentFY - 2, 10, 1)
					VAR PriorFYEnd = DATE(CurrentFY - 1, 9, 30)
					RETURN
						CALCULATE(
							SELECTEDMEASURE(),
							'SnapshotDate_End'[Snapshot Date] >= PriorFYStart,
							'SnapshotDate_End'[Snapshot Date] <= PriorFYEnd,
							ALL('SnapshotDate_End'),
							ALL('SnapshotDate_Start')
						)
				ordinal: 5

			/// All time cumulative total
			calculationItem 'All Time' =
					CALCULATE(
						SELECTEDMEASURE(),
						ALL('SnapshotDate_End'),
						ALL('SnapshotDate_Start')
					)
				ordinal: 6

		column 'Period Selector'
			dataType: string
			lineageTag: 22222222-3333-4444-5555-666666666602
			summarizeBy: none
			sourceColumn: Name
			sortByColumn: Ordinal

		column Ordinal
			dataType: int64
			isHidden
			lineageTag: 22222222-3333-4444-5555-666666666603
			summarizeBy: sum
			sourceColumn: Ordinal

		partition 'Period Selector' = calculationGroup

================================================================================
ALSO UPDATE PERSPECTIVES (find and replace these sections):
================================================================================

Find this in Executive View perspective (around line 2920):
		perspectiveTable SnapshotDate_End

			perspectiveColumn 'Snapshot Date'

Replace with:
		perspectiveTable SnapshotDate_End

			perspectiveColumn 'Snapshot Date'

		perspectiveTable 'Time Comparison'
			includeAll

		perspectiveTable 'Period Selector'
			includeAll

--------------------------------------------------------------------------------

Find this in Manager View perspective (around line 2973):
		perspectiveTable SnapshotDate_End
			includeAll

Replace with:
		perspectiveTable SnapshotDate_End
			includeAll

		perspectiveTable 'Time Comparison'
			includeAll

		perspectiveTable 'Period Selector'
			includeAll

--------------------------------------------------------------------------------

Find this in HR Analyst View perspective (around line 2999):
		perspectiveTable SnapshotDate_End
			includeAll

Replace with:
		perspectiveTable SnapshotDate_End
			includeAll

		perspectiveTable 'Time Comparison'
			includeAll

		perspectiveTable 'Period Selector'
			includeAll

================================================================================
